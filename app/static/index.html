<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vox-9 ‚Äî Generate Assets</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1.5rem; }
    .layout { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; }
    .panel { border: 1px solid #333; border-radius: 10px; padding: 1rem; }
    h2 { margin: 0 0 .5rem; }
    .muted { color: #777; }
    .row { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; }
    button { padding: .6rem 1rem; border-radius: 10px; border: 0; background: #4f46e5; color: #fff; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .ghost { background: transparent; border: 1px solid #444; color: inherit; }
    .box { border: 2px dashed #555; border-radius: 12px; padding: 1.4rem; text-align: center; }
    .box.dragover { border-color: #4f46e5; background: rgba(79,70,229,.08); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .4rem .25rem; border-bottom: 1px solid #333; text-align: left; }
    th { font-weight: 600; }
    code { background: rgba(0,0,0,.25); padding: .1rem .3rem; border-radius: 6px; }
    a { text-decoration: none; }
    .crumbs { font-size: .9rem; margin-bottom: .4rem; }
    .crumbs a { color: inherit; }
    .spacer { height: .75rem; }
    .results td:nth-child(1){ width: 120px; }
  </style>
</head>
<body>
  <h1>Vox-9 ‚Äî Generate Assets</h1>
  <div class="layout">
    <!-- LEFT: S3 Explorer -->
    <div class="panel">
      <h2>Your Files</h2>
      <div class="crumbs"><span id="crumbs"></span></div>
      <div class="row">
        <button id="btnHome" class="ghost">Home</button>
        <button id="btnUp" class="ghost">Up</button>
        <button id="btnRefresh" class="ghost">Refresh</button>
      </div>
      <div class="spacer"></div>
      <div id="explorer"></div>
    </div>

    <!-- RIGHT: Upload + Generate -->
    <div class="panel">
      <h2>Upload Story & Generate</h2>
      <p class="muted">Drop a text file or pick from your computer. Or select an existing story from the file browser.</p>

      <div id="drop" class="box">
        <div><strong>Drag & drop</strong> your <em>.txt / .srt / .ass</em> here</div>
        <div class="spacer"></div>
        <div class="row">
          <input type="file" id="picker" accept=".txt,.srt,.ass,text/plain,text/*" />
          <button id="btnChoose" class="ghost">Choose a file</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="uploadStatus" class="muted">No file uploaded</div>

      <div class="spacer"></div>
      <div class="row">
        <label>Voice:</label>
        <select id="voice"></select>
        <button id="btnVoices" class="ghost">Refresh voices</button>
      </div>

      <div class="spacer"></div>
      <div>
        <strong>Outputs:</strong>
        <label><input type="checkbox" class="out" value="mp3" checked> MP3</label>
        <label><input type="checkbox" class="out" value="wav"> WAV</label>
        <label><input type="checkbox" class="out" value="srt" checked> SRT</label>
        <label><input type="checkbox" class="out" value="ass"> ASS</label>
        <label><input type="checkbox" class="out" value="vtt"> VTT</label>
        <label><input type="checkbox" class="out" value="mp4"> MP4</label>
      </div>

      <div class="spacer"></div>
      <div class="row">
        <button id="btnGenerate" disabled>Generate assets</button>
        <span id="genStatus" class="muted"></span>
      </div>

      <div class="spacer"></div>
      <div id="result"></div>
    </div>
  </div>

  <script>
    const apiBase = location.origin;

    // ---------- Elements
    const explorer = document.getElementById('explorer');
    const crumbsEl = document.getElementById('crumbs');
    const btnHome = document.getElementById('btnHome');
    const btnUp = document.getElementById('btnUp');
    const btnRefresh = document.getElementById('btnRefresh');

    const drop = document.getElementById('drop');
    const picker = document.getElementById('picker');
    const btnChoose = document.getElementById('btnChoose');
    const uploadStatus = document.getElementById('uploadStatus');
    const btnGenerate = document.getElementById('btnGenerate');
    const genStatus = document.getElementById('genStatus');
    const result = document.getElementById('result');

    const voiceSel = document.getElementById('voice');
    const btnVoices = document.getElementById('btnVoices');

    let cwd = 'projects/';     // current folder prefix
    let currentStoryKey = null;// story selected from explorer (or uploaded)

    // ---------- Helpers
    function setDrag(el, on) { el.classList.toggle('dragover', on); }
    function nameFromKey(key){ const parts = key.split('/').filter(Boolean); return parts[parts.length-1] || key; }
    function parentPrefix(prefix){
      const p = prefix.endsWith('/') ? prefix.slice(0, -1) : prefix;
      const ix = p.lastIndexOf('/');
      return ix >= 0 ? p.slice(0, ix+1) : '';
    }
    function renderCrumbs(prefix){
      const parts = prefix.split('/').filter(Boolean);
      let acc = '';
      const links = ['<a href="#" data-pref="projects/">projects</a>'];
      for (let i=1;i<parts.length;i++){
        acc += parts[i] + '/';
        links.push(`<span>/</span> <a href="#" data-pref="projects/${acc}">${parts[i]}</a>`);
      }
      crumbsEl.innerHTML = links.join(' ');
      crumbsEl.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click', (e)=>{ e.preventDefault(); cwd = a.dataset.pref; loadTree(); });
      });
    }

    // ---------- S3 Explorer
    async function tree(prefix){
      const url = new URL(`${apiBase}/api/tree`);
      url.searchParams.set('prefix', prefix);
      const res = await fetch(url);
      const data = await res.json().catch(()=>({folders:[],files:[],error:'Bad JSON'}));
      if (!res.ok) data.error = data.error || `HTTP ${res.status}`;
      return data; // {folders, files, error?}
    }

    async function loadTree(){
      renderCrumbs(cwd);
      explorer.innerHTML = 'Loading‚Ä¶';
      try {
        const data = await tree(cwd);
        if (data.error) {
          explorer.innerHTML = `<div class="muted">Failed to load: ${data.error}</div>`;
          return;
        }
        const flds = data.folders || [];
        const files = data.files || [];
        const rows = [];
        if (!flds.length && !files.length){
          rows.push(`<div class="muted">Empty</div>`);
        } else {
          if (flds.length){
            rows.push(`<table><thead><tr><th>Name</th><th></th></tr></thead><tbody>`);
            for (const f of flds){
              const n = nameFromKey(f.slice(0,-1));
              rows.push(`<tr><td>üìÅ <a href="#" class="nav" data-pref="${f}">${n}</a></td><td></td></tr>`);
            }
            rows.push(`</tbody></table>`);
          }
          <!-- inside loadTree(), when rendering files -->
          if (files.length){
            rows.push(`<table><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody>`);
            for (const it of files){
              const n = nameFromKey(it.key);
              const isTxt = /\.txt$/i.test(n);
              rows.push(`<tr>
                <td>üìÑ ${n}</td>
                <td>
                  ${isTxt ? `<button class="useStory" data-key="${it.key}">Use as story</button>` : ``}
                  <button class="dl" data-key="${it.key}">Download</button>
                  <button class="rm" data-key="${it.key}">Delete</button>
                </td>
              </tr>`);
            }
            rows.push(`</tbody></table>`);
          }
        }
        explorer.innerHTML = rows.join('');

        explorer.querySelectorAll('.nav').forEach(a=>{
          a.addEventListener('click', (e)=>{ e.preventDefault(); cwd = a.dataset.pref; loadTree(); });
        });
        explorer.querySelectorAll('.dl').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const k = btn.getAttribute('data-key');
            const r = await fetch(`${apiBase}/api/presign_download?key=${encodeURIComponent(k)}`);
            const d = await r.json();
            const a = document.createElement('a');
            a.href = d.url; a.download = ''; a.target = '_blank'; a.rel='noopener';
            document.body.appendChild(a); a.click(); a.remove();
          });
        });
        explorer.querySelectorAll('.useStory').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            currentStoryKey = btn.getAttribute('data-key');
            uploadStatus.innerHTML = `Story selected ‚úì <code>${currentStoryKey}</code>`;
            btnGenerate.disabled = false;
          });
        });
        explorer.querySelectorAll('.rm').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const k = btn.getAttribute('data-key');
            if (!confirm(`Delete ${k}? This can‚Äôt be undone.`)) return;
            try {
              const r = await fetch(`${apiBase}/api/object?key=${encodeURIComponent(k)}`, { method: 'DELETE' });
              const d = await r.json();
              if (!r.ok) throw new Error(d?.detail || 'Delete failed');
              loadTree();
            } catch (e) {
              console.error(e);
              alert('Delete failed');
            }
          });
        });

      } catch (e) {
        explorer.innerHTML = '<div class="muted">Failed to load (unexpected)</div>';
        console.error(e);
      }
    }

    btnHome.addEventListener('click', ()=>{ cwd = 'projects/'; loadTree(); });
    btnUp.addEventListener('click', ()=>{ const p = parentPrefix(cwd); cwd = p || 'projects/'; loadTree(); });
    btnRefresh.addEventListener('click', loadTree);

    // ---------- Upload
    ['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); setDrag(drop, true); }));
    ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); setDrag(drop, false); }));

    drop.addEventListener('drop', async (e) => {
      const f = e.dataTransfer.files?.[0];
      if (f) await uploadFile(f);
    });

    btnChoose.addEventListener('click', () => picker.click());
    picker.addEventListener('change', async () => {
      const f = picker.files?.[0];
      if (f) await uploadFile(f);
      picker.value = '';
    });

    async function presignStory(filename, type) {
      const url = `${apiBase}/api/presign_story?filename=${encodeURIComponent(filename)}&content_type=${encodeURIComponent(type || 'text/plain')}`;
      const res = await fetch(url, { method: 'POST' });
      if (!res.ok) throw new Error('presign failed');
      return res.json();
    }

    async function s3Post(url, fields, file) {
      const form = new FormData();
      Object.entries(fields).forEach(([k, v]) => form.append(k, v));
      form.append('file', file);
      const r = await fetch(url, { method: 'POST', body: form });
      const body = await r.text();
      if (!r.ok) { console.error('S3 upload failed', r.status, body); throw new Error('S3 upload failed'); }
      return body;
    }

    async function uploadFile(file) {
      try {
        btnGenerate.disabled = true;
        result.innerHTML = '';
        uploadStatus.textContent = 'Requesting upload‚Ä¶';
        const ps = await presignStory(file.name, file.type || 'text/plain');
        await s3Post(ps.url, ps.fields, file);
        currentStoryKey = ps.fields.key;
        uploadStatus.innerHTML = `Uploaded ‚úì <code>${file.name}</code> ‚Üí <code>${currentStoryKey}</code>`;
        btnGenerate.disabled = false;
        const parts = currentStoryKey.split('/'); // projects/<story>/<file>
        if (parts.length >= 3) {
          cwd = `projects/${parts[1]}/`;
          loadTree();
        }
      } catch (e) {
        console.error(e);
        uploadStatus.textContent = 'Upload failed';
      }
    }

    // ---------- Voices
    async function loadVoices(){
      voiceSel.innerHTML = '<option value="">Loading‚Ä¶</option>';
      try {
        const res = await fetch(`${apiBase}/api/voices`);
        const data = await res.json();
        const voices = data.voices || [];
        const def = data.default_voice_id || '';
        const opts = voices.map(v => `<option value="${v.voice_id}">${v.name}</option>`).join('');
        voiceSel.innerHTML = opts || '<option value="">(no voices)</option>';
        if (def) voiceSel.value = def;
      } catch (e) {
        console.error(e);
        voiceSel.innerHTML = '<option value="">(failed to load voices)</option>';
      }
    }
    btnVoices.addEventListener('click', loadVoices);

    // ---------- Generate assets
    function selectedOutputs(){
      return Array.from(document.querySelectorAll('input.out:checked')).map(i=>i.value);
    }

    btnGenerate.addEventListener('click', async () => {
      if (!currentStoryKey) return;
      const outs = selectedOutputs();
      if (!outs.length) { alert('Select at least one output type.'); return; }

      btnGenerate.disabled = true;
      genStatus.textContent = 'Generating‚Ä¶';
      result.innerHTML = '';
      try {
        const voice_id = voiceSel.value || undefined;
        const res = await fetch(`${apiBase}/api/generate_assets`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ s3_story_key: currentStoryKey, voice_id, outputs: outs })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || 'Generation failed');

        const rows = (data.assets || []).map(a =>
          `<tr><td>${a.type.toUpperCase()}</td><td><a href="${a.url}" download target="_blank" rel="noopener">${a.key.split('/').pop()}</a></td></tr>`
        ).join('');
        result.innerHTML = rows ? `<table class="results"><thead><tr><th>Type</th><th>Download</th></tr></thead><tbody>${rows}</tbody></table>` : '<div class="muted">No assets returned</div>';

        genStatus.textContent = 'Done ‚úì';
        loadTree(); // refresh to show new assets
      } catch (e) {
        console.error(e);
        genStatus.textContent = 'Failed';
        result.innerHTML = '<div class="muted">Generation failed</div>';
      } finally {
        btnGenerate.disabled = false;
      }
    });

    // ---------- Init
    (async function init(){
      await Promise.all([loadTree(), loadVoices()]);
    })();
  </script>
</body>
</html>
